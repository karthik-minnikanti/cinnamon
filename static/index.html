<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .connection-row:hover {
            background-color: #f8f9fa;
        }

        .error-badge {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-3">
        <h1>Network Connection Monitor</h1>

        <div class="row mb-3">
            <div class="col">
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="loadConnections()">Refresh</button>
                    <button class="btn btn-outline-primary" onclick="filterByError('ECONNREFUSED')">Connection
                        Refused</button>
                    <button class="btn btn-outline-primary" onclick="filterByError('ECONNABORTED')">Connection
                        Aborted</button>
                    <button class="btn btn-outline-primary" onclick="filterByError('ECONNRESET')">Connection
                        Reset</button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Process</th>
                        <th>Local Address</th>
                        <th>Remote Address</th>
                        <th>Protocol</th>
                        <th>State</th>
                        <th>Error</th>
                    </tr>
                </thead>
                <tbody id="connectionsTable">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleString();
        }

        function createErrorBadge(error) {
            if (!error) return '';
            return `<span class="badge bg-danger error-badge" onclick="filterByError('${error}')">${error}</span>`;
        }

        function loadConnections() {
            fetch('/api/connections')
                .then(response => response.json())
                .then(connections => {
                    const tbody = document.getElementById('connectionsTable');
                    tbody.innerHTML = '';

                    connections.forEach(conn => {
                        const row = document.createElement('tr');
                        row.className = 'connection-row';
                        row.innerHTML = `
                            <td>${formatDate(conn.timestamp)}</td>
                            <td>${conn.process_name} (${conn.process_id})</td>
                            <td>${conn.local_addr}</td>
                            <td>${conn.remote_addr}</td>
                            <td>${conn.protocol}</td>
                            <td>${conn.state}</td>
                            <td>${createErrorBadge(conn.error)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error loading connections:', error));
        }

        function filterByError(error) {
            fetch(`/api/connections/error/${error}`)
                .then(response => response.json())
                .then(connections => {
                    const tbody = document.getElementById('connectionsTable');
                    tbody.innerHTML = '';

                    connections.forEach(conn => {
                        const row = document.createElement('tr');
                        row.className = 'connection-row';
                        row.innerHTML = `
                            <td>${formatDate(conn.timestamp)}</td>
                            <td>${conn.process_name} (${conn.process_id})</td>
                            <td>${conn.local_addr}</td>
                            <td>${conn.remote_addr}</td>
                            <td>${conn.protocol}</td>
                            <td>${conn.state}</td>
                            <td>${createErrorBadge(conn.error)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error filtering connections:', error));
        }

        // Load connections on page load
        loadConnections();

        // Refresh every 5 seconds
        setInterval(loadConnections, 5000);
    </script>
</body>

</html>